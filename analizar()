# ================================
# üîÑ LOOP PRINCIPAL (ANTI-CRASH + ANTI-FREEZE + HEARTBEAT)
# ================================
def analizar():
    send("üöÄ CryptoSniper FX ‚Äî Versi√≥n 8.3 Activada (Anti-Crash + Anti-Freeze ON)")

    ultimo_resumen = ""
    ultima_senal = datetime.now(mx)       # √∫ltima se√±al (BUY/SELL)
    ultima_actividad = datetime.now(mx)   # √∫ltima vez que el bot analiz√≥ correctamente

    while True:
        try:
            ahora = datetime.now(mx)
            fecha = ahora.strftime("%Y-%m-%d")
            hubo_senal = False

            # ----------------------------------------------------
            # üî• ANTI-FREEZE ‚Üí Si no hay actividad en 10 minutos, reiniciar ciclo
            # ----------------------------------------------------
            if (ahora - ultima_actividad).seconds > 600:
                send("‚ö† Reinicio autom√°tico (ANTI-FREEZE): No hubo actividad en 10 minutos.")
                ultima_actividad = datetime.now(mx)

            # ========================================================
            # üîç ANALIZAR TODOS LOS ACTIVOS
            # ========================================================
            for asset in SYMBOLS.keys():

                # Protecci√≥n contra velas corruptas
                try:
                    velas5m = obtener_velas(asset, "5m")
                    if not velas5m or len(velas5m) < 12:
                        continue
                except:
                    continue

                # Detectar confluencias
                try:
                    cons = detectar_confluencias(velas5m)
                    total = sum(cons.values())
                    price = velas5m[-1][4]
                except:
                    continue

                # Marcar actividad real
                ultima_actividad = datetime.now(mx)

                # Alertas
                if total == 3:
                    send(f"üìç Setup en formaci√≥n: {asset} ({total} confluencias)")
                if total == 4:
                    send(f"‚ö† Entrada posible: {asset} ({total} confluencias)")

                # Se√±al >= 4
                if total >= 4:
                    try:
                        msg = procesar_senal(asset, cons, price)
                        if msg:
                            send(msg)
                            hubo_senal = True
                            ultima_senal = datetime.now(mx)
                    except Exception as e:
                        send(f"‚ö† Error al ejecutar operaci√≥n: {e}")
                        continue

            # ========================================================
            # üïí HEARTBEAT CADA 1 HORA
            # ========================================================
            if datetime.now(mx) - ultima_senal >= timedelta(hours=1):
                send("‚è≥ Analizando mercado‚Ä¶ (sin se√±ales fuertes en la √∫ltima hora)")
                ultima_senal = datetime.now(mx)

            # ========================================================
            # üìù RESUMEN DIARIO
            # ========================================================
            if ahora.hour == 22 and fecha != ultimo_resumen:
                resumen_diario(send)
                ultimo_resumen = fecha

            # Espera entre ciclos
            time.sleep(300)  # 5 minutos

        # ================================================================
        # üî• ANTI-CRASH GLOBAL ‚Üí El bot NUNCA se apaga
        # ================================================================
        except Exception as e:
            send(f"üî• Auto-Recuperaci√≥n completa: Error cr√≠tico detectado y reiniciado.\nError: {e}")
            time.sleep(5)
            continue
